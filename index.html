<!DOCTYPE html>
<html>
    <head>
        <title>Video Streaming Demonstration</title>
        <link rel="stylesheet" href="static/css/style.css">
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        <script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
    </head>
    <body>
        <div class="menu" data-id="menu">
            <div class="title">Video Streaming Demonstration</div>
            <div class="cameras"></div>
            <div class="controller">
                <div class="item" data-click="view-all">檢視全部</div>
            </div>
        </div>
        <main><div class="views" data-id="views"></div></main>
        <script tpl="menu-camera-list" type="text/html">
            <div data-view-id="${viewId}" class="item">camera ${viewId}</div>
        </script>
        <script tpl="view-camera-list" type="text/html">
            <div class="view-grid" data-view-id="${viewId}">
                <div class="label">ch-${viewId} fps</div>
                <img>
            </div>
        </script>
        <script>
            (function(){
                var
                REMOTE_ADDR = 'http://134.208.3.188:8000',
                CAMERA_LSIT = [ '0', '1', '2', '3' ],

                menu        = $('[data-id="menu"]'),
                menuRegion  = {
                    cameras:    menu.find('.cameras'),
                    controller: menu.find('.controller')
                },
                viewport    = $('[data-id="views"]'),
                tpl         = {
                    menuCameraList: $('script[tpl="menu-camera-list"]').html(),
                    viewCameraList: $('script[tpl="view-camera-list"]').html()
                };



                $.each( CAMERA_LSIT, function(idx, cameraId){
                    ___REGISTER_VIEW( REMOTE_ADDR + '/video/', cameraId );
                } );



                menuRegion.cameras.on('click', '[data-view-id]', function(e){
                    var
                    target = $(e.target),
                    viewId = target.data('view-id');

                    ___CLEAR_ALL_STATE();
                    viewport.find('[data-view-id="' + viewId + '"]').click();
                });

                menuRegion.controller.on('click', '[data-click="view-all"]', ___CLEAR_ALL_STATE);

                viewport.on('click', '[data-view-id]', function(e){
                    var target = $(e.target);

                    if( target.data('state') === 'full' ){
                        target.siblings().removeClass('hide');
                        target.removeClass('view-full');
                        target.data('state', '');
                        return;
                    }



                    target.siblings().addClass('hide').removeClass('view-full');
                    target.addClass('view-full');
                    target.data('state', 'full');
                });



                function ___REGISTER_VIEW( apiAddr, cameraId ){
                    $.tmpl( tpl.menuCameraList, { viewId: cameraId } ).appendTo( menuRegion.cameras );
                    $.tmpl( tpl.viewCameraList, { viewId: cameraId } ).appendTo( viewport );

                    var
                    source = new EventSource( apiAddr + cameraId ),
                    dataView = viewport.find('[data-view-id="' + cameraId + '"]');


                    dataView.height( dataView.width() / 640 * 480 );

                    source.onmessage = function(e){
                        var
                        data        = e.data.split('___'),
                        image       = data[0],
                        prediction  = data[1];

                        dataView.find('img').attr('src', 'data:image/jpeg;base64,' + image);
                    };

                    source.onerror = function(e){
                        console.log(e);
                        source.close();
                    };
                }

                function ___CLEAR_ALL_STATE(){
                    viewport.find('[data-view-id]').removeClass('hide view-full').data('state', '');
                }
            })();
        </script>
    </body>
</html>
